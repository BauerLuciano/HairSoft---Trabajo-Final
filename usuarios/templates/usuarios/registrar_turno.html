<template>
  <div class="login-container">
    <div class="login-card">
      <h1 class="login-title">Registrar Turno</h1>
      <p class="login-subtitle">Completa los datos del turno</p>

      <form @submit.prevent="crearTurno" class="login-form">
        <!-- Cliente -->
        <div class="input-group">
          <input 
            type="text" 
            v-model="form.clienteNombre" 
            @input="buscarCliente" 
            class="input-field" 
            placeholder=" " 
          />
          <label class="input-label">Cliente (*)</label>
          <ul v-if="clientesSugeridos.length" class="sugerencias-list">
            <li v-for="c in clientesSugeridos" :key="c.id" @click="seleccionarCliente(c)">
              {{ c.nombre }} {{ c.apellido }}
            </li>
          </ul>
        </div>

        <!-- Fecha -->
        <div class="input-group">
          <input 
            type="text" 
            ref="fecha" 
            v-model="form.fecha" 
            class="input-field" 
            placeholder=" " 
          />
          <label class="input-label">Fecha (*)</label>
        </div>

        <!-- Hora -->
        <div class="input-group">
          <input 
            type="text" 
            ref="hora" 
            v-model="form.hora" 
            class="input-field" 
            placeholder=" " 
          />
          <label class="input-label">Hora (*)</label>
        </div>

        <!-- Peluquero -->
        <div class="input-group">
          <select v-model="form.peluquero" class="input-field">
            <option value="">Seleccionar peluquero</option>
            <option v-for="p in peluqueros" :key="p.id" :value="p.id">{{ p.nombre }}</option>
          </select>
          <label class="input-label">Peluquero (*)</label>
        </div>

        <!-- Servicio -->
        <div class="input-group">
          <select v-model="form.servicio" class="input-field">
            <option value="">Seleccionar servicio</option>
            <option v-for="s in servicios" :key="s.id" :value="s.id">{{ s.nombre }}</option>
          </select>
          <label class="input-label">Servicio (*)</label>
        </div>

        <button type="submit" class="login-button">Guardar</button>
      </form>
    </div>
  </div>
</template>

<script>
import flatpickr from "flatpickr";
import "flatpickr/dist/flatpickr.min.css";

export default {
  data() {
    return {
      form: {
        cliente: null,
        clienteNombre: '',
        fecha: '',
        hora: '',
        peluquero: '',
        servicio: ''
      },
      clientesSugeridos: [],
      peluqueros: [],
      servicios: []
    };
  },
  mounted() {
    // Inicializar flatpickr
    flatpickr(this.$refs.fecha, {
      dateFormat: "Y-m-d",
      minDate: "today",
      maxDate: new Date().fp_incr(7)
    });
    flatpickr(this.$refs.hora, {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
      minuteIncrement: 20
    });

    this.cargarServicios();
    this.cargarPeluqueros();
  },
  methods: {
    async cargarServicios() {
      const res = await fetch('http://localhost:8000/usuarios/api/servicios/');
      this.servicios = await res.json();
    },
    async cargarPeluqueros() {
      const res = await fetch('http://localhost:8000/usuarios/api/peluqueros/');
      this.peluqueros = await res.json();
    },
    async buscarCliente() {
      if (!this.form.clienteNombre) {
        this.clientesSugeridos = [];
        return;
      }
      const res = await fetch(`http://localhost:8000/usuarios/api/clientes/?q=${this.form.clienteNombre}`);
      const data = await res.json();
      this.clientesSugeridos = data.results;
    },
    seleccionarCliente(c) {
      this.form.cliente = c.id;
      this.form.clienteNombre = `${c.nombre} ${c.apellido}`;
      this.clientesSugeridos = [];
    },
    async crearTurno() {
      const res = await fetch('http://localhost:8000/usuarios/api/turnos/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.form)
      });
      if (res.ok) {
        alert('Turno registrado con Ã©xito');
        this.form = { cliente: null, clienteNombre: '', fecha: '', hora: '', peluquero: '', servicio: '' };
      } else {
        alert('Error al registrar turno');
      }
    }
  }
};
</script>

<style scoped>
.sugerencias-list {
  background: rgba(20,20,20,0.9);
  color: white;
  list-style: none;
  padding: 5px;
  margin: 0;
  border-radius: 8px;
  max-height: 150px;
  overflow-y: auto;
  position: absolute;
  z-index: 100;
}
.sugerencias-list li {
  padding: 6px 10px;
  cursor: pointer;
}
.sugerencias-list li:hover {
  background: rgba(0,153,255,0.3);
}
</style>
